{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.13", "generated_at": "2025-10-04T21:34:18.990995Z", "invocation_id": "20a491d9-c220-416e-bff6-034945b98e67", "invocation_started_at": "2025-10-04T21:34:11.489609Z", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-10-04T21:34:14.393554Z", "completed_at": "2025-10-04T21:34:14.409143Z"}, {"name": "execute", "started_at": "2025-10-04T21:34:14.410146Z", "completed_at": "2025-10-04T21:34:18.920946Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 4.530915260314941, "adapter_response": {"_message": "SELECT 23038", "code": "SELECT", "rows_affected": 23038}, "message": "SELECT 23038", "failures": null, "unique_id": "model.milestone2_analytics.golden_table", "compiled": true, "compiled_code": "\n\n-- Golden table intended grain: one row per (ncessch) for academic year 2021\n-- Duplicate sources previously:\n--  * location_data grouped by an unselected 'county' column -> implicit duplication\n--  * grade_eight included multiple grades per school -> row explosion when joining on ncessch\n--  * possible duplicate directory rows per school\n-- Strategy: normalize each CTE to its key, then join; add ROW_NUMBER diagnostics.\n\nWITH location_data AS (\n        SELECT\n                zip,\n                county_fips,\n                state,\n                state_fips,\n                AVG(latitude) AS avg_lat,\n                AVG(longitude) AS avg_lon,\n                COUNT(*) AS coordinate_count\n        FROM test.location_data\n        WHERE latitude IS NOT NULL\n            AND longitude IS NOT NULL\n        GROUP BY zip, county_fips, state, state_fips  -- removed stray 'county'\n),\ncensus_2021 AS (\n    SELECT\n        c.zip_code,\n        (c.males_10_14 + c.females_10_14) AS total_10_14,\n        c.total_pop,\n        (c.males_10_14 + c.females_10_14) / NULLIF(c.total_pop, 0) AS pct_10_14,\n        (c.females_10_14 / NULLIF(c.males_10_14 + c.females_10_14, 0)) AS pct_female_10_14,\n        c.hhi_150k_200k,\n        c.hhi_220k_plus,\n        loc.state,\n        loc.state_fips,\n        loc.county_fips,\n        loc.avg_lat,\n        loc.avg_lon,\n        loc.coordinate_count\n    FROM test.census_data c\n    LEFT JOIN location_data loc ON c.zip_code = loc.zip\n    WHERE c.year = 2021\n      AND c.total_pop > 0  -- Filter out empty areas\n),\ngrade_eight AS (\n    -- Only keep grade 8; collapse to single row per school\n    SELECT\n        ncessch,\n        SUM(enrollment::numeric) as grade_eight_enrollment\n    FROM test.urban_ccd_enrollment_grade_8_exp\n    WHERE (year_json::numeric)=2021\n      AND grade = '8'\n    GROUP BY ncessch\n),\nschools_2021 AS (\n    SELECT DISTINCT\n        d.school_name,\n        d.ncessch,\n        d.school_status,\n        d.enrollment,\n\t\tge.grade_eight_enrollment,\n        d.teachers_fte,\n        d.school_type,\n        d.zip_location AS zip_code\n    FROM test.urban_ccd_directory_exp d\n\tLEFT JOIN grade_eight ge ON ge.ncessch = d.ncessch\n    WHERE (d.year_json::numeric)=2021\n),\ntests_2021 AS (\n\tSELECT\n\t\tncessch,\n\t\tmax(math_test_num_valid) as math_test_num_valid ,\n\t\tmax(math_test_pct_prof_high) as math_test_pct_prof_high,\n\t\tmax(math_test_pct_prof_low) as math_test_pct_prof_low,\n\t\tmax(math_test_pct_prof_midpt) as math_test_pct_prof_midpt,\n\t\tmax(read_test_num_valid) as read_test_num_valid,\n\t\tmax(read_test_pct_prof_high) as read_test_pct_prof_high,\n\t\tmax(read_test_pct_prof_low) as read_test_pct_prof_low,\n\t\tmax(read_test_pct_prof_midpt) as read_test_pct_prof_midpt\n\tFROM test.urban_edfacts_assessments_grade_8_race_sex_exp\n\tWHERE (year_json::numeric)=2020\n\tGROUP BY ncessch\n),\nwalk as(\n    SELECT\n        statefp,\n        countyfp,\n        AVG(natwalkind) as avg_natwalkind\n    FROM test.walk_index\n    GROUP BY statefp, countyfp\n),\nfinal_dataset AS (\n    SELECT\n\t\ts.school_name,\n        --s.ncessch,\n        s.school_type,\n        s.teachers_fte::numeric,\n        s.enrollment,\n\t\ts.grade_eight_enrollment,\n\t\ttest.math_test_num_valid::numeric as math_counts,\n\t\ttest.math_test_pct_prof_high::numeric as math_high_pct,\n\t\ttest.math_test_pct_prof_low::numeric as math_low_pct,\n\t\ttest.read_test_num_valid::numeric as read_counts,\n\t\ttest.read_test_pct_prof_high::numeric as read_high_pct,\n\t\ttest.read_test_pct_prof_low::numeric as read_low_pct,\n        --c.zip_code,\n        --c.state,\n        ROUND(c.hhi_150k_200k::DECIMAL / NULLIF(c.total_pop, 0) * 100, 2) AS pct_hhi_150k_200k,\n        ROUND(c.hhi_220k_plus::DECIMAL / NULLIF(c.total_pop, 0) * 100, 2) AS pct_hhi_220k_plus,\n        walk.avg_natwalkind,\n        c.total_10_14,\n        c.pct_10_14,\n        c.pct_female_10_14,\n        c.total_pop,\n        c.hhi_150k_200k,\n        c.hhi_220k_plus,\n        COUNT(*) OVER (PARTITION BY c.zip_code, c.state) AS schools_in_zip,\n        ROW_NUMBER() OVER (PARTITION BY s.ncessch ORDER BY c.state, c.zip_code) AS dup_rank\n    FROM census_2021 c\n    INNER JOIN schools_2021 s ON c.zip_code = s.zip_code\n\tINNER JOIN tests_2021 test ON test.ncessch = s.ncessch\n    INNER JOIN walk ON walk.statefp = c.state_fips AND walk.countyfp = c.county_fips\n)\nSELECT *\nFROM final_dataset\nWHERE dup_rank = 1  -- enforce one row per school\nORDER BY school_name", "relation_name": "\"milestone2\".\"dev\".\"golden_table\"", "batch_results": null}], "elapsed_time": 5.170801877975464, "args": {"require_resource_names_without_spaces": true, "require_yaml_configuration_for_mf_time_spines": false, "send_anonymous_usage_stats": true, "print": true, "quiet": false, "require_generic_test_arguments_property": true, "log_level": "info", "require_batched_execution_for_custom_microbatch_strategy": false, "use_colors": true, "favor_state": false, "project_dir": "D:\\docs\\MADS\\696-Milestone 2\\dbt_project", "show_resource_report": false, "cache_selected_only": false, "state_modified_compare_more_unrendered_values": false, "strict_mode": false, "require_explicit_package_overrides_for_builtin_materializations": true, "warn_error_options": {"error": [], "warn": [], "silence": []}, "source_freshness_run_project_hooks": true, "show_all_deprecations": false, "skip_nodes_if_on_run_start_fails": false, "empty": false, "upload_to_artifacts_ingest_api": false, "populate_cache": true, "validate_macro_args": false, "select": ["path:models/dev"], "use_colors_file": true, "introspect": true, "log_file_max_bytes": 10485760, "indirect_selection": "eager", "log_path": "D:\\docs\\MADS\\696-Milestone 2\\dbt_project\\logs", "use_fast_test_edges": false, "state_modified_compare_vars": false, "exclude": [], "log_format": "default", "require_all_warnings_handled_by_warn_error": false, "static_parser": true, "vars": {}, "write_json": true, "partial_parse": true, "log_level_file": "debug", "require_nested_cumulative_type_params": false, "printer_width": 80, "version_check": true, "which": "run", "defer": false, "profiles_dir": ".", "log_format_file": "debug", "invocation_command": "dbt run --profiles-dir . --select path:models/dev", "macro_debugging": false, "partial_parse_file_diff": true}}
