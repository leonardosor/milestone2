version: '3.8'

services:
  db:
    image: postgis/postgis:15-3.3
    container_name: milestone2-db
    environment:
      POSTGRES_DB: ${DB_NAME:-milestone2}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./database/postgis-init.sql:/docker-entrypoint-initdb.d/02-postgis.sql
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - milestone2-network

  streamlit:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: milestone2-streamlit
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-milestone2}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_SCHEMA: ${DB_SCHEMA:-test}
      DATABASE_TYPE: ${DATABASE_TYPE:-local}
    ports:
      - "8501:8501"
    volumes:
      - ./app:/app
      - ./etl/src:/app/etl_modules
      - ./dbt_project:/app/dbt_project
      - ./notebooks:/app/notebooks
      - etl_logs:/app/logs
      - model_artifacts:/app/models
    depends_on:
      db:
        condition: service_healthy
    networks:
      - milestone2-network
    command: streamlit run streamlit_app.py --server.port=8501 --server.address=0.0.0.0

  etl:
    build:
      context: ./etl
      dockerfile: Dockerfile
    container_name: milestone2-etl
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-milestone2}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_SCHEMA: ${DB_SCHEMA:-test}
      DATABASE_TYPE: ${DATABASE_TYPE:-local}
      APP_CONFIG: /app/config/config.json
    volumes:
      - ./etl/src:/app/src
      - ./etl/config:/app/config
      - ./dbt_project:/app/dbt_project
      - etl_logs:/app/logs
      - tiger_data:/app/data/tiger
    depends_on:
      db:
        condition: service_healthy
    networks:
      - milestone2-network
    # Run on-demand via docker exec or Streamlit triggers
    command: tail -f /dev/null

networks:
  milestone2-network:
    driver: bridge

volumes:
  postgres_data:
  etl_logs:
  model_artifacts:
  tiger_data:
